generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USERS & COMPANIES ====================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  password          String
  firstName         String
  lastName          String
  phone             String?
  isActive          Boolean   @default(true)
  emailVerified     DateTime?
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  
  role              Role      @default(CLIENT_PRO)
  
  companyId         String?
  company           Company?  @relation(fields: [companyId], references: [id])
  
  assignedCustomers Company[] @relation("SalesRepCustomers")
  
  // Relations
  carts             Cart[]
  orders            Order[]
  savedCarts        SavedCart[]
  tickets           Ticket[]
  ticketMessages    TicketMessage[]
  auditLogs         AuditLog[]
  importJobs        ImportJob[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([companyId])
  @@index([email])
  @@map("users")
}

model Company {
  id                String    @id @default(cuid())
  name              String
  ice               String?   @unique
  ifField           String?   @unique
  rc                String?   
  cnss              String?   
  address           String?
  city              String?
  postalCode        String?
  country           String    @default("Maroc")
  phone             String?
  email             String?
  
  isApproved        Boolean   @default(false)
  approvalStatus    ApprovalStatus @default(PENDING)
  paymentTerms      PaymentTerms @default(TRANSFER_30)
  creditLimit       Decimal?  @db.Decimal(12, 2)
  
  priceListId       String?
  priceList         PriceList? @relation(fields: [priceListId], references: [id])
  
  users             User[]
  salesRepId        String?
  salesRep          User?     @relation("SalesRepCustomers", fields: [salesRepId], references: [id])
  
  addresses         Address[]
  orders            Order[]
  invoices          Invoice[]
  tickets           Ticket[]
  carts             Cart[]
  customerPrices    CustomerPrice[]
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([isApproved])
  @@map("companies")
}

model Address {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  postalCode  String?
  country     String   @default("Maroc")
  isDefault   Boolean  @default(false)
  isBilling   Boolean  @default(false)
  isShipping  Boolean  @default(true)
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([companyId])
  @@map("addresses")
}

// ==================== CATALOG ====================

model Category {
  id            String    @id @default(cuid())
  name          String
  slug          String    @unique
  description   String?
  image         String?
  isActive      Boolean   @default(true)
  sortOrder     Int       @default(0)
  
  parentId      String?
  parent        Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children      Category[] @relation("CategoryHierarchy")
  
  products      Product[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([parentId])
  @@index([isActive])
  @@map("categories")
}

model Brand {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  logo        String?
  description String?
  isActive    Boolean   @default(true)
  
  products    Product[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([isActive])
  @@map("brands")
}

model Product {
  id              String    @id @default(cuid())
  sku             String    @unique
  barcode         String?   @unique
  name            String
  slug            String    @unique
  description     String?
  shortDescription String?
  
  // B2B specific
  unit            UnitType  @default(UNIT)
  packSize        Int       @default(1)
  moq             Int       @default(1)
  maxPerOrder     Int?
  
  // Pricing
  basePrice       Decimal   @db.Decimal(10, 2)
  publicPrice     Decimal?  @db.Decimal(10, 2)
  promoPrice      Decimal?  @db.Decimal(10, 2)
  promoStart      DateTime?
  promoEnd        DateTime?
  vatRate         Decimal   @default(0.20) @db.Decimal(5, 2)
  
  // Stock
  stockQuantity   Int       @default(0)
  reservedStock   Int       @default(0)
  lowStockThreshold Int     @default(10)
  
  // Status
  isActive        Boolean   @default(true)
  
  // Relations
  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id])
  brandId         String?
  brand           Brand?    @relation(fields: [brandId], references: [id])
  
  images          ProductImage[]
  
  // Pricing overrides
  customerPrices  CustomerPrice[]
  
  // Order relations
  orderItems      OrderItem[]
  cartItems       CartItem[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([categoryId])
  @@index([brandId])
  @@index([isActive])
  @@index([sku])
  @@map("products")
}

model ProductImage {
  id          String   @id @default(cuid())
  url         String
  alt         String?
  sortOrder   Int      @default(0)
  isPrimary   Boolean  @default(false)
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@index([productId])
  @@map("product_images")
}

// ==================== PRICING ====================

model PriceList {
  id            String    @id @default(cuid())
  name          String
  description   String?
  isDefault     Boolean   @default(false)
  
  companies     Company[]
  customerPrices CustomerPrice[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("price_lists")
}

model CustomerPrice {
  id          String    @id @default(cuid())
  price       Decimal   @db.Decimal(10, 2)
  
  companyId   String?
  company     Company?  @relation(fields: [companyId], references: [id])
  
  priceListId String?
  priceList   PriceList? @relation(fields: [priceListId], references: [id])
  
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([companyId, productId])
  @@unique([priceListId, productId])
  @@index([productId])
  @@map("customer_prices")
}

// ==================== CART ====================

model Cart {
  id          String   @id @default(cuid())
  
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  items       CartItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId])
  @@index([companyId])
  @@map("carts")
}

model CartItem {
  id          String   @id @default(cuid())
  quantity    Int
  
  cartId      String
  cart        Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

model SavedCart {
  id          String   @id @default(cuid())
  name        String
  items       Json     // Array of {productId, quantity}
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("saved_carts")
}

// ==================== ORDERS ====================

model Order {
  id              String    @id @default(cuid())
  orderNumber     String    @unique
  
  status          OrderStatus @default(CREATED)
  statusHistory   OrderStatusHistory[]
  
  // Totals
  subtotal        Decimal   @db.Decimal(12, 2)
  vatAmount       Decimal   @db.Decimal(12, 2)
  discountAmount  Decimal   @default(0) @db.Decimal(12, 2)
  total           Decimal   @db.Decimal(12, 2)
  
  // Payment
  paymentTerms    PaymentTerms
  paymentStatus   PaymentStatus @default(PENDING)
  paidAt          DateTime?
  
  // Relations
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id])
  
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  // Shipping
  shippingAddress Json
  billingAddress  Json?
  
  // Notes
  customerNote    String?
  internalNote    String?
  
  // Items
  items           OrderItem[]
  
  // Invoice
  invoice         Invoice?
  
  // For sales reps
  placedBySalesRep Boolean @default(false)
  salesRepId      String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  sku         String   // Snapshot
  name        String   // Snapshot
  
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  vatRate     Decimal  @db.Decimal(5, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderStatusHistory {
  id          String   @id @default(cuid())
  status      OrderStatus
  previousStatus OrderStatus?
  note        String?
  
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  changedBy   String?  // User ID or "system"
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

// ==================== INVOICES ====================

model Invoice {
  id              String   @id @default(cuid())
  invoiceNumber   String   @unique
  
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id])
  
  companyId       String
  company         Company  @relation(fields: [companyId], references: [id])
  
  subtotal        Decimal  @db.Decimal(12, 2)
  vatAmount       Decimal  @db.Decimal(12, 2)
  total           Decimal  @db.Decimal(12, 2)
  
  status          InvoiceStatus @default(UNPAID)
  issueDate       DateTime @default(now())
  dueDate         DateTime
  paidAt          DateTime?
  
  pdfUrl          String?
  
  payments        Payment[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model Payment {
  id          String   @id @default(cuid())
  amount      Decimal  @db.Decimal(12, 2)
  method      PaymentMethod
  reference   String?
  notes       String?
  
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  @@index([invoiceId])
  @@map("payments")
}

// ==================== SUPPORT TICKETS ====================

model Ticket {
  id          String    @id @default(cuid())
  ticketNumber String   @unique
  subject     String
  description String
  
  status      TicketStatus @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  category    TicketCategory
  
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id])
  
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  messages    TicketMessage[]
  
  assignedTo  String?   // Admin user ID
  resolvedAt  DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([createdAt])
  @@map("tickets")
}

model TicketMessage {
  id          String   @id @default(cuid())
  content     String
  isInternal  Boolean  @default(false)
  
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  attachments Json?    // Array of file URLs
  
  createdAt   DateTime @default(now())

  @@index([ticketId])
  @@index([createdAt])
  @@map("ticket_messages")
}

// ==================== IMPORT/EXPORT & AUDIT ====================

model ImportJob {
  id            String    @id @default(cuid())
  type          ImportType
  fileName      String
  
  status        ImportStatus @default(PENDING)
  
  totalRows     Int       @default(0)
  successRows   Int       @default(0)
  errorRows     Int       @default(0)
  
  previewData   Json?
  errors        Json?
  errorReportUrl String?
  
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  
  executedAt    DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@map("import_jobs")
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  oldValues   Json?
  newValues   Json?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== ENUMS ====================

enum Role {
  CLIENT_PRO
  SALES_REP
  ADMIN
  SUPER_ADMIN
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentTerms {
  CASH
  TRANSFER_30
  TRANSFER_45
  TRANSFER_60
  CHEQUE_30
  CHEQUE_45
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CHEQUE
  CREDIT_CARD
}

enum UnitType {
  UNIT
  CARTON
  BOX
  PALLET
}

enum OrderStatus {
  CREATED
  CONFIRMED
  PREPARING
  PREPARED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  ORDER_ISSUE
  PRODUCT_QUESTION
  SHIPPING
  INVOICING
  ACCOUNT
  TECHNICAL
  OTHER
}

enum ImportType {
  PRODUCT_FULL
  PRODUCT_STOCK
  PRODUCT_PRICE
  CUSTOMER
}

enum ImportStatus {
  PENDING
  VALIDATING
  VALIDATED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
